<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Sidus/EAVModelBundle</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css"
          integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <link rel="stylesheet" href="https://vincentchalnot.github.io/SidusEAVModelBundle/css/main.css">
</head>
<body>

<div class="position-relative p-md-3 text-center bg-dark border-bottom mb-4 dark-background"
     style="">
    <div class="my-5">
        <a href="https://vincentchalnot.github.io/SidusEAVModelBundle" class="btn">
            <h1 class="display-4 text-white">
                Sidus/EAVModelBundle&nbsp;<i
                        class="fa fa-database"></i>
            </h1>
        </a>
        <p class="lead font-weight-normal text-white">
            Blazing fast data modeling with Symfony
        </p>
                    <a class="btn btn-dark" href="https://github.com/VincentChalnot/SidusEAVModelBundle" target="_blank">
                View on GitHub <i class="fa fa-code-branch"></i>
            </a>
            </div>
</div>

    <a href="https://github.com/VincentChalnot/SidusEAVModelBundle">
        <img class="fixed-top" style="left:auto"
             src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
             alt="Fork me on GitHub">
    </a>

<main class="container">
    <div class="row">
                    <div class="col-sm-3 pr-4">
                <nav role="navigation">
                                                                    <p class="text-muted">
                            Home
                        </p>

                        <ul class="nav nav-pills flex-column">
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/index.html">
                                        Introduction
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/index.html#example">
                                        Example
                                    </a>
                                </li>
                                                    </ul>
                                                                        <hr>
                                                <p class="text-muted">
                            Main documentation
                        </p>

                        <ul class="nav nav-pills flex-column">
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/01-install.html">
                                        01 - Installation
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/02-model.html">
                                        02 - Model configuration
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/03-multiple.html">
                                        03 - Multiple attributes & collections
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/04-entities.html">
                                        04 - Handling Entities
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/05.1-form.html">
                                        05 - Forms
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/06-validate.html">
                                        06 - Validation
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/07.1-query.html">
                                        07 - Query
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/08-translate.html">
                                        08 - Translating the model
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/09-context.html">
                                        19 - EAV Contextualisation
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/10-serialize.html">
                                        10 - Serialization
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/11-extend.html">
                                        11 - Extending & customizing the model
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/12-custom_classes.html">
                                        12 - Custom classes
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/13-extensions.html">
                                        13 - Extensions
                                    </a>
                                </li>
                                                    </ul>
                                                                        <hr>
                                                <p class="text-muted">
                            Other documentation entries
                        </p>

                        <ul class="nav nav-pills flex-column">
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/100-ide_autocomplete.html">
                                        IDE Autocomplete
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/200-questions.html">
                                        Questions & Answers
                                    </a>
                                </li>
                                                            <li class="nav-item">
                                    <a class="nav-link"
                                       href="https://vincentchalnot.github.io/SidusEAVModelBundle/Documentation/300-performances.html">
                                        Performances
                                    </a>
                                </li>
                                                    </ul>
                    
                </nav>
            </div>

                <section class="col-sm-9">
            <h2 id="how-to-query-data">How to query data</h2>
<table>
<thead>
<tr>
<th>WARNING</th>
</tr>
</thead>
<tbody>
<tr>
<td>This chapter explore the different ways you can query data using the API, if you want to optimize the actual loading of the data, checkout this chapter:</td>
</tr>
<tr>
<td><a href="07.2-query-optimization.html">Data loading optimization</a></td>
</tr>
</tbody>
</table>
<h3 id="using-the-eavfinder">Using the EAVFinder</h3>
<p>If you don't need to build complex queries using AND, OR and multiple conditions over the same attributes, you can use
the EAVFinder helper service which behave like Doctrine's findBy() method.</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $family
 * @var \Sidus\EAVModelBundle\Doctrine\EAVFinder $eavFinder
 * @var \Sidus\EAVModelBundle\Entity\DataInterface $author
*/
$results = $eavFinder-&gt;findBy($family, [
    'published' =&gt; true,
    'author' =&gt; $author,
]);</code></pre>
<p>You can also use the slightly more advanced filterBy method which allows you to define your operators</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $family
 * @var \Sidus\EAVModelBundle\Doctrine\EAVFinder $eavFinder
 * @var \Sidus\EAVModelBundle\Entity\DataInterface $author
*/
$results = $eavFinder-&gt;filterBy($family, [
    ['published', '=', true],
    ['title', 'like', 'My little %'],
]);</code></pre>
<p>Also, this service allows you to fetch the Query Builder instead of the results so you can modify it to your needs:</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $family
 * @var \Sidus\EAVModelBundle\Doctrine\EAVFinder $eavFinder
 * @var \Sidus\EAVModelBundle\Entity\DataInterface $author
*/
$qb = $eavFinder-&gt;getFilterByQb($family, [
    ['published', '=', true],
    ['title', 'like', 'My little %'],
]);

$qb // For example if you want to filter on a property that is not a EAV attribute:
    -&gt;andWhere('e.updatedAt &gt; :date')
    -&gt;setParameter('date', new DateTime('yesterday'));

$results = $qb-&gt;getQuery()-&gt;getResult();</code></pre>
<h3 id="fetching-the-repository">Fetching the repository</h3>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $family
 * @var \Doctrine\Bundle\DoctrineBundle\Registry $doctrine
 * @var \CleverAge\EAVManager\EAVModelBundle\Entity\DataRepository $dataRepository
 * @var integer $id
*/
$dataRepository = $doctrine-&gt;getRepository($family-&gt;getDataClass());

$dataRepository-&gt;find($id);</code></pre>
<h2 id="eavquerybuilder">EAVQueryBuilder</h2>
<p>Sometimes you want to programmatically search for entities in your database.
When using a traditional relational model in Doctrine you can query your database
with the QueryBuilder and the DQL language.
When using an EAV model, you need to make a join on the values table each time you
put a condition on the value of an attribute and the resulting queries are really
complicated to write and to maintain manually.</p>
<p>Introducing the EAVQueryBuilder:</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Entity\DataRepository $dataRepository
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $categoryFamily
 */

// Initializing a new EAVQueryBuilder from the Category family
$eavQb = $dataRepository-&gt;createFamilyQueryBuilder($categoryFamily);

// Creating the proper DQL and parameters to match some category codes
$dqlHandler = $eavQb-&gt;a('categoryCode')-&gt;in([
    'books',
    'comics',
]);

// Apply dql to main query builder
$qb = $eavQb-&gt;apply($dqlHandler);

// Fetching result, the traditional Doctrine's way
$categories = $qb-&gt;getQuery()-&gt;getResult();</code></pre>
<p>So basically, we need the family and the data repository to create the EAV
query builder instance, like a classic query builder.</p>
<p>We use the syntax :</p>
<pre><code class="language-php">$eavQb-&gt;a({{ATTRIBUTE_CODE}})-&gt;{{OPERATOR}}({{VALUE}});</code></pre>
<p>To generate an DQLHandler instance that contains the DQL and the parameters that
will be used later to build the doctrine query builder.</p>
<p>In the end, we apply the DQLHandler to the main EAVQueryBuilder instance to fetch
the Doctrine query builder.</p>
<p>In a more complex example, you can create imbricated DQLHandlers with AND and OR
conditions:</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Entity\DataRepository $dataRepository
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $bookFamily
 * @var \Sidus\EAVModelBundle\Entity\DataInterface[] $categories
 */
$eavQb = $dataRepository-&gt;createFamilyQueryBuilder($bookFamily);

$eavQb-&gt;addOrderBy($eavQb-&gt;a('title'), 'DESC');

$qb = $eavQb-&gt;apply($eavQb-&gt;getOr([
    $eavQb-&gt;getAnd([
        $eavQb-&gt;a('publicationStatus')-&gt;in(['validated', 'published']),
        $eavQb-&gt;a('price')-&gt;lte(16),
        $eavQb-&gt;a('title')-&gt;like('%programming%'),
    ]),
    $eavQb-&gt;getAnd([
        $eavQb-&gt;a('title')-&gt;like('%example%'),
        $eavQb-&gt;a('categories')-&gt;in($categories), // Fetched earlier
        $eavQb-&gt;a('tomeNumber')-&gt;between(2, 4),
    ]),
]));

$books = $qb-&gt;getQuery()-&gt;getResult();</code></pre>
<p>The end result would look like this in relational SQL:</p>
<pre><code class="language-sql">SELECT * FROM Book b WHERE (
    (
        b.publicationStatus IN ('validated', 'published') AND
        b.price &lt;= 16 AND
        b.title LIKE '%programming%'
    )
    OR
    (
        b.title LIKE '%example%' AND
        b.categoried IN (37, 42) AND
        b.tomeNumber BETWEEN 2 AND 4
    )
)
ORDER BY b.title DESC</code></pre>
<h3 id="joining-on-eav-relations">Joining on EAV relations</h3>
<p>In this example, we will use the Book -&gt; Category relation through the attribute
<code>Book.categories</code>.</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Entity\DataRepository $dataRepository
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $bookFamily
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $categoryFamily
 */

// Initializing a new EAVQueryBuilder from the Book family
$eavQb = $dataRepository-&gt;createFamilyQueryBuilder($bookFamily);

// We need to fetch the Category.categoryCode attribute manually as it's not
// part of the root family
$categoryCodeAttribute = $categoryFamily-&gt;getAttribute('categoryCode');

// Apply dql to main query builder
$qb = $eavQb-&gt;apply(
    $eavQb-&gt;a('categories')-&gt;join()-&gt;attribute($categoryCodeAttribute)-&gt;in([
        'books',
        'comics',
    ])
);

// Fetching result, the traditional Doctrine's way
$categories = $qb-&gt;getQuery()-&gt;getResult();</code></pre>
<h3 id="multiple-conditions-on-the-same-attribute">Multiple conditions on the same attribute</h3>
<p>You need to build the attribute query builder apart and use the clone method.
This way the same join will be used but you will be able to add as many conditions as you want.</p>
<pre><code class="language-php">&lt;?php
/**
 * @var \Sidus\EAVModelBundle\Entity\DataRepository $dataRepository
 * @var \Sidus\EAVModelBundle\Model\FamilyInterface $bookFamily
 */

// Initializing a new EAVQueryBuilder from the Book family
$eavQb = $dataRepository-&gt;createFamilyQueryBuilder($bookFamily);

// We need the attribute query builder to clone it
$publicationDateAttributeQb = $eavQb-&gt;a('publicationDate');

// Apply dql to main query builder
$qb = $eavQb-&gt;apply(
    $eavQb-&gt;getOr([
        $publicationDateAttributeQb-&gt;between(new DateTime('last monday'), new DateTime()),
        (clone $publicationDateAttributeQb)-&gt;isNull(),
    ])
);

// Fetching result, the traditional Doctrine's way
$categories = $qb-&gt;getQuery()-&gt;getResult();</code></pre>
        </section>
    </div>
</main>

<footer class="container-fluid mt-4">
    <div class="row">
        <div class="col-12 text-center border-top pt-4 pb-4">
            <span>
                                    Copyright <a href="https://twitter.com/VincentChalnot" target="_blank">@VincentChalnot</a> 2015-2018 with special thanks to <a href="https://www.clever-age.com/" target="_blank">Clever-Age</a>
                            </span>
        </div>
    </div>
</footer>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>

<script>
    hljs.initHighlighting();
</script>
</body>
</html>
